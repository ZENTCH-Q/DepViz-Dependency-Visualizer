:root {
  --bg: #0e1116;
  --fg: #e6e6e6;
  --muted: #8b8b8b;
  --card: #1b2130;
  --module-bg: #141922;
  --accent: #62a0ea;
  --outline: #8a919a;
  --grid1: rgba(255,255,255,0.12);
  --grid2: rgba(255,255,255,0.08);
  --hover: #2a3347;
  --selected: #1fb6ff;
  --shadow: rgba(0,0,0,0.5);
  --hi-white: #ffffff;
  --hi-cyan: #00ffff;

  /* one knob to slow/speed all theme transitions */
  --theme-dur: 2.5s;
}

html[data-theme="light"] {
  --module-bg: #e9edf4;
  --bg: #fafafa;
  --fg: #111;
  --muted: #666;
  --card: #ffffff;
  --accent: #1a73e8;
  --outline: #747a80;
  --grid1: rgba(0,0,0,0.18);
  --grid2: rgba(0,0,0,0.10);
  --hover: #eef3ff;
  --selected: #0ea5e9;
  --shadow: rgba(0,0,0,0.15);
  --hi-white: #000;
  --hi-cyan: #06b6d4;
}

/* smoothen basic color swaps (non-gradient surfaces) */
body {
  transition: background-color var(--theme-dur) ease-in-out,
              color var(--theme-dur) ease-in-out;
}

/* overlay used for cross-fade; background set inline via JS */
.theme-fade {
  position: fixed;
  inset: 0;
  pointer-events: none;
  opacity: 1;
  transition: opacity var(--theme-dur) ease-in-out;
  z-index: 9999;
}

@media (prefers-reduced-motion: reduce) {
  * { transition: none !important; animation: none !important; }
}

html, body { height: 100%; }
body {
  background: var(--bg);
  color: var(--fg);
  margin: 0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}

/* toolbar */
#toolbar {
  position: absolute; top: 8px; left: 8px;
  display: flex; align-items: center; gap: 8px;
  background: var(--card);
  padding: 6px 10px; border-radius: 8px;
  box-shadow: 0 4px 16px var(--shadow);
  z-index: 10;
  transition: background-color var(--theme-dur) ease-in-out,
              color var(--theme-dur) ease-in-out,
              box-shadow var(--theme-dur) ease-in-out,
              border-color var(--theme-dur) ease-in-out;
}

#themeToggle { cursor: pointer; }
#toolbar button {
  background: var(--hover);
  color: var(--fg);
  border: 1px solid var(--outline);
  border-radius: 6px;
  padding: 4px 8px;
  cursor: pointer;
  transition: background-color var(--theme-dur) ease-in-out,
              color var(--theme-dur) ease-in-out,
              border-color var(--theme-dur) ease-in-out;
}
#toolbar button:hover { filter: brightness(1.05); }

/* canvas + dual grid layers for flicker-free cross-fade */
#canvasWrapper {
  position: absolute; inset: 0;
  overflow: hidden;
  --grid-s1: 28px;   /* fine grid */
  --grid-s2: 140px;  /* coarse grid */
}

/* DARK grid layer */
#canvasWrapper::before,
#canvasWrapper::after {
  content: "";
  position: absolute; inset: 0;
  pointer-events: none;
  will-change: opacity;
  transition: opacity var(--theme-dur) ease-in-out;
  z-index: 0;
}

/* Dark visuals on ::before */
#canvasWrapper::before {
  opacity: 1;
  background:
    radial-gradient(circle at 50% 40%, rgba(0,0,0,0.16), transparent 65%),
    radial-gradient(rgba(255,255,255,0.06) 1.2px, transparent 1.2px),
    radial-gradient(rgba(255,255,255,0.03) 1.2px, transparent 1.2px),
    url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFklEQVQYV2NkYGD4z0ABYBwTA0YAAHRfBv0F6mZ0AAAAAElFTkSuQmCC');
  background-size:
    100% 100%, var(--grid-s1) var(--grid-s1), var(--grid-s2) var(--grid-s2), 8px 8px;
  background-position: 0 0, 0 0, 0 0, 0 0;
  background-repeat: no-repeat, repeat, repeat, repeat;
}

/* Light visuals on ::after (darker dots so theyâ€™re visible) */
#canvasWrapper::after {
  opacity: 0;
  background:
    radial-gradient(circle at 50% 40%, rgba(0,0,0,0.08), transparent 65%),
    radial-gradient(rgba(0,0,0,0.22) 1.2px, transparent 1.2px),
    radial-gradient(rgba(0,0,0,0.12) 1.2px, transparent 1.2px),
    url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAFklEQVQYV2NkYGD4z0ABYBwTA0YAAHRfBv0F6mZ0AAAAAElFTkSuQmCC');
  background-size:
    100% 100%, var(--grid-s1) var(--grid-s1), var(--grid-s2) var(--grid-s2), 8px 8px;
  background-position: 0 0, 0 0, 0 0, 0 0;
  background-repeat: no-repeat, repeat, repeat, repeat;
}

/* Flip visible layer in light theme */
html[data-theme="light"] #canvasWrapper::before { opacity: 0; }
html[data-theme="light"] #canvasWrapper::after  { opacity: 1; }

#canvas { width: 100%; height: 100%; }
svg, #canvasWrapper, #canvas {
  -webkit-user-select: none;
  user-select: none;
}

text, .module-title, .module-badge, .label, .badge {
  pointer-events: none;
  -webkit-user-select: none;
  user-select: none;
  transition: fill var(--theme-dur) ease-in-out,
              color var(--theme-dur) ease-in-out;
}

/* Modules */
.module {
  fill: var(--module-bg);
  stroke: var(--outline);
  stroke-width: 1.6;
  rx: 10; ry: 10;
  cursor: grab;
  transition: fill var(--theme-dur) ease-in-out,
              stroke var(--theme-dur) ease-in-out,
              box-shadow var(--theme-dur) ease-in-out;
}
.module.dragging { cursor: grabbing; }
g.module-group.hover rect.module { stroke: var(--hi-white); }
g.module-group.selected rect.module { stroke: var(--hi-white); stroke-width: 2.6; }
.module-group:hover rect.module,
.class-group:hover rect.class,
.func-group:hover rect.func { filter: drop-shadow(0 8px 24px var(--shadow)); }
.module-title { font-size: 12px; fill: var(--fg); font-weight: 600; }
.module-badge { font-size: 10px; fill: var(--muted); }
.status-dot {
  stroke: var(--bg);
  stroke-width: 2;
}

/* Classes (nested containers) */
.class {
  fill: var(--module-bg);
  stroke: var(--outline);
  stroke-width: 1.4;
  rx: 8; ry: 8;
  cursor: grab;
  transition: fill var(--theme-dur) ease-in-out,
              stroke var(--theme-dur) ease-in-out,
              box-shadow var(--theme-dur) ease-in-out;
}
.class.dragging { cursor: grabbing; }

/* Functions */
.func {
  fill: var(--card);
  stroke: var(--outline);
  stroke-width: 1.4;
  rx: 8; ry: 8;
  cursor: grab;
  transition: fill var(--theme-dur) ease-in-out,
              stroke var(--theme-dur) ease-in-out,
              box-shadow var(--theme-dur) ease-in-out;
}
.func.dragging { cursor: grabbing; }
g.func-group.hover rect.func { stroke-width: 1.8; stroke: var(--hi-white); }
g.func-group.selected rect.func { stroke-width: 2.6; stroke: var(--hi-white); }
.label { font-size: 12px; fill: var(--fg); pointer-events: none; }
.badge { font-size: 10px; fill: var(--muted); }

/* Edges */
.edge {
  fill: none;
  stroke-width: 2.2;
  pointer-events: stroke;
  transition: stroke var(--theme-dur) ease-in-out;
}
.edge.import { stroke-dasharray: 8 6; stroke-linecap: butt; }
.edge.call   { stroke-dasharray: none; stroke-linecap: round; }
.edge.unresolved { opacity: .35; stroke-dasharray: 3 3; }

.edge.hover { stroke-width: 3.2; }
.edge.selected { stroke-width: 3.2; stroke: var(--hi-white); }
.edge.hidden { opacity: 0; pointer-events: none; }
.edge-arrow.transparent { opacity: 0; pointer-events: none; }

.edge-arrow { fill: currentColor; stroke: none; pointer-events: none; transition: color var(--theme-dur) ease-in-out; }
.edge-arrow.import { color: #a8b1ff; }
.edge-arrow.call   { color: #86efac; }

.node-related rect { stroke: var(--hi-cyan) !important; stroke-width: 2.4 !important; }
.node-hidden { display: none !important; }
.ghost rect.module { opacity: 0.6; }

.transparent, .node-transparent { opacity: 0 !important; pointer-events: none !important; }

/* Search highlight */
.search-mark { fill: rgba(255, 255, 0, 0.35); rx: 3; ry: 3; pointer-events: none; }

/* Legend */
#legend {
  position: absolute; right: 8px; top: 8px; z-index: 9;
  background: var(--card); padding: 6px 10px; border-radius: 8px;
  box-shadow: 0 4px 16px var(--shadow);
  display: flex; gap: 12px; align-items: center;
  user-select: none;
  transition: background-color var(--theme-dur) ease-in-out,
              color var(--theme-dur) ease-in-out,
              box-shadow var(--theme-dur) ease-in-out,
              border-color var(--theme-dur) ease-in-out;
}

/* Depth slider */
#sliceDepth {
  position: absolute; right: 8px; top: 56px; z-index: 9;
  background: var(--card); padding: 6px 10px; border-radius: 8px;
  box-shadow: 0 4px 16px var(--shadow);
  display: flex; align-items: center; gap: 8px;
  user-select: none;
  transition: background-color var(--theme-dur) ease-in-out,
              color var(--theme-dur) ease-in-out,
              box-shadow var(--theme-dur) ease-in-out,
              border-color var(--theme-dur) ease-in-out;
}
#sliceDepth input { width: 120px; }
#sliceDepth label { color: var(--muted); font-size: 12px; }

.legend-item { display:flex; align-items:center; gap:6px; cursor:pointer; }
.legend-item.off { opacity: 0.35; }
.legend-svg { width: 38px; height: 10px; display:inline-block; }

/* Type colors */
.edge.import, .legend-path.import { stroke: #a8b1ff; }
.edge.call,   .legend-path.call   { stroke: #86efac; }

/* Snippet panel placeholder */
#snippet { display:none; }

/* Context menu */
.context-menu {
  position: fixed;
  display: none;
  background: var(--card);
  border: 1px solid var(--outline);
  border-radius: 6px;
  box-shadow: 0 6px 24px var(--shadow);
  z-index: 100;
  padding: 4px;
  min-width: 120px;
  transition: background-color var(--theme-dur) ease-in-out,
              color var(--theme-dur) ease-in-out,
              box-shadow var(--theme-dur) ease-in-out,
              border-color var(--theme-dur) ease-in-out;
}
.context-menu button {
  display: block;
  width: 100%;
  padding: 6px 10px;
  background: transparent;
  border: 0;
  color: var(--fg);
  text-align: left;
  cursor: pointer;
}
.context-menu button:hover { background: var(--hover); }

/* Cascaded submenu */
.context-sub { position: fixed; }

/* Search popup */
#searchPopup {
  position: fixed;
  left: 50%; bottom: 20px; transform: translateX(-50%);
  background: var(--card);
  border: 1px solid var(--outline);
  border-radius: 8px;
  padding: 8px 10px;
  box-shadow: 0 8px 28px var(--shadow);
  z-index: 120;
  display: none; /* set to flex when open */
  align-items: center;
  gap: 10px;
  transition: background-color var(--theme-dur) ease-in-out,
              color var(--theme-dur) ease-in-out,
              border-color var(--theme-dur) ease-in-out,
              box-shadow var(--theme-dur) ease-in-out;
}
#searchPopup input {
  width: 360px; max-width: 60vw;
  background: transparent; border: 0; outline: none; color: var(--fg);
  font-size: 14px;
}
#searchControls { margin-top: 0; display: flex; gap: 8px; align-items: center; }
#searchControls button {
  background: var(--hover);
  color: var(--fg);
  border: 1px solid var(--outline);
  border-radius: 4px;
  padding: 2px 8px;
  cursor: pointer;
  transition: background-color var(--theme-dur) ease-in-out,
              color var(--theme-dur) ease-in-out,
              border-color var(--theme-dur) ease-in-out;
}
#searchControls #searchCount { color: var(--muted); min-width: 48px; text-align: center; }
